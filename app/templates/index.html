{% extends "layout.html" %}

{% block content %}
        <div class="mx-auto py-2 sm:px-2">
					<!-- row -->
					<div class="flex flex-wrap klsuaonrmcha">
						<div class="shrink max-w-full uajskeiolksb w-full">
					    <p class="text-xl font-bold mt-3 mb-5">Exome Analysis</p>
					  </div>
          	<div class="shrink max-w-full uajskeiolksb w-full sm:w-1/2 lg:w-1/4 mb-6">
          		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg h-full">
							  <div class="pt-6 dkslaoeyhnmj text-sm font-semibold">
							  	Total Analyses
							  </div>
							  <div class="flex klsuaonrmcha vlaoethsnkma dkslaoeyhnmj py-4">
							  	<div class="self-center size-14 boalstehwqbj text-blue-500 bg-blue-100 dark:bg-blue-900/40 relative text-center">
								  	<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="absolute top-1/2 start-1/2 transform -translate-y-1/2 ltr:-translate-x-1/2 rtl:translate-x-1/2 size-8 bi bi-clipboard-data" viewBox="0 0 16 16">
										  <path d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0v-1zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0V7zM7 9a1 1 0 0 1 2 0v3a1 1 0 1 1-2 0V9z"/>
										  <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
										  <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
										</svg>
									</div>
							    <h2 class="self-center text-3xl">{{ total_analyses or 0 }}</h2>
							  </div>
							  <div class="dkslaoeyhnmj pb-6"></div>
							</div>
						</div>
						<div class="shrink max-w-full uajskeiolksb w-full sm:w-1/2 lg:w-1/4 mb-6">
          		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg h-full">
							  <div class="pt-6 dkslaoeyhnmj text-sm font-semibold">
							  	Active Individuals
							  </div>
							  <div class="flex klsuaonrmcha vlaoethsnkma dkslaoeyhnmj py-4">
							  	<div class="self-center size-14 boalstehwqbj text-green-500 bg-green-100 dark:bg-green-900/40 relative text-center">
								  	<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="absolute top-1/2 start-1/2 transform -translate-y-1/2 ltr:-translate-x-1/2 rtl:translate-x-1/2 size-8 bi bi-person-check" viewBox="0 0 16 16">
										  <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm1.679-4.493-1.335 2.226a.75.75 0 0 1-1.174.144l-.774-.773a.5.5 0 0 1 .708-.708l.547.548 1.17-1.951a.5.5 0 1 1 .858.514ZM11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/>
										  <path d="M8.256 14a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Z"/>
										</svg>
									</div>
							    <h2 class="self-center text-3xl">{{ total_individuals or 0 }}</h2>
							  </div>
							  <div class="dkslaoeyhnmj pb-6"></div>
							</div>
						</div>
						<div class="shrink max-w-full uajskeiolksb w-full sm:w-1/2 lg:w-1/4 mb-6">
          		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg h-full">
							  <div class="pt-6 dkslaoeyhnmj text-sm font-semibold">
							  	Success Rate
							  </div>
							  <div class="flex klsuaonrmcha vlaoethsnkma dkslaoeyhnmj py-4">
							  	<div class="self-center size-14 boalstehwqbj text-emerald-500 bg-emerald-100 dark:bg-emerald-900/40 relative text-center">
								  	<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="absolute top-1/2 start-1/2 transform -translate-y-1/2 ltr:-translate-x-1/2 rtl:translate-x-1/2 size-8 bi bi-check-circle" viewBox="0 0 16 16">
										  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
										  <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
										</svg>
									</div>
							    <h2 class="self-center text-3xl">{{ success_rate or 0 }}%</h2>
							  </div>
							  <div class="dkslaoeyhnmj pb-6"></div>
							</div>
						</div>
						<div class="shrink max-w-full uajskeiolksb w-full sm:w-1/2 lg:w-1/4 mb-6">
          		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg h-full">
							  <div class="pt-6 dkslaoeyhnmj text-sm font-semibold">
							  	Avg Processing
							  </div>
							  <div class="flex klsuaonrmcha vlaoethsnkma dkslaoeyhnmj py-4">
							  	<div class="self-center size-14 boalstehwqbj text-purple-500 bg-purple-100 dark:bg-purple-900/40 relative text-center">
								  	<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="absolute top-1/2 start-1/2 transform -translate-y-1/2 ltr:-translate-x-1/2 rtl:translate-x-1/2 size-8 bi bi-clock" viewBox="0 0 16 16">
										  <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
										  <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
										</svg>
									</div>
							    <h2 class="self-center text-3xl">{{ mean_runtime or "N/A" }}</h2>
							  </div>
							  <div class="dkslaoeyhnmj pb-6"></div>
							</div>
						</div>
					</div>

					<!-- row -->
					<div class="flex flex-wrap klsuaonrmcha">
          	<div class="shrink max-w-full uajskeiolksb w-full lg:w-1/2 mb-6">
              <!-- Analysis Status -->
              <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg mb-6">
	              <div class="relative">
                  <div class="flex ioajsklehsnm mb-6">
                    <h4 class="text-base font-bold">Analysis Status</h4>
                    <span class="text-gray-500 text-sm">Status of analysis process</span>
                  </div>

                  <!-- Two-column layout: Chart (80%) + Legend (20%) -->
                  <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Pie Chart Column (80%) -->
                    <div class="lg:w-4/5 w-full">
                      <div class="flex justify-center items-center h-64">
                        <div class="relative w-56 h-56">
                          <canvas id="AnalysisStatusChart" class="max-w-full max-h-full"></canvas>
                        </div>
                      </div>
                      <!-- Total Summary -->
                      <div class="text-center mt-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                          Total Analyses: <span class="font-semibold">{{ total_analyses or 0 }}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Legend Column (20%) -->
                    <div class="lg:w-1/5 w-full">
                      <div class="space-y-2">
                        <!-- Pending -->
                        <div class="flex items-center justify-between p-2 rounded border" style="background-color: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3);">
                          <div class="flex items-center flex-1">
                            <div class="w-2.5 h-2.5 rounded-full mr-2" style="background-color: rgb(234, 179, 8);"></div>
                            <span class="text-xs font-medium" style="color: rgb(146, 114, 5);">Pending</span>
                          </div>
                          <span class="text-sm font-bold text-right" style="color: rgb(146, 114, 5);">{{ pending_analyses or 0 }}</span>
                        </div>

                        <!-- Running -->
                        <div class="flex items-center justify-between p-2 rounded border" style="background-color: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                          <div class="flex items-center flex-1">
                            <div class="w-2.5 h-2.5 rounded-full mr-2" style="background-color: rgb(59, 130, 246);"></div>
                            <span class="text-xs font-medium" style="color: rgb(37, 85, 156);">Running</span>
                          </div>
                          <span class="text-sm font-bold text-right" style="color: rgb(37, 85, 156);">{{ running_analyses or 0 }}</span>
                        </div>

                        <!-- Completed -->
                        <div class="flex items-center justify-between p-2 rounded border" style="background-color: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.4);">
                          <div class="flex items-center flex-1">
                            <div class="w-2.5 h-2.5 rounded-full mr-2" style="background-color: rgb(34, 197, 94);"></div>
                            <span class="text-xs font-medium" style="color: rgb(21, 128, 61);">Completed</span>
                          </div>
                          <span class="text-sm font-bold text-right" style="color: rgb(21, 128, 61);">{{ successful_analyses or 0 }}</span>
                        </div>

                        <!-- Failed -->
                        <div class="flex items-center justify-between p-2 rounded border" style="background-color: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
                          <div class="flex items-center flex-1">
                            <div class="w-2.5 h-2.5 rounded-full mr-2" style="background-color: rgb(239, 68, 68);"></div>
                            <span class="text-xs font-medium" style="color: rgb(153, 27, 27);">Failed</span>
                          </div>
                          <span class="text-sm font-bold text-right" style="color: rgb(153, 27, 27);">{{ failed_analyses or 0 }}</span>
                        </div>

                        <!-- Cancelled -->
                        <div class="flex items-center justify-between p-2 rounded border" style="background-color: rgba(107, 114, 128, 0.1); border-color: rgba(107, 114, 128, 0.3);">
                          <div class="flex items-center flex-1">
                            <div class="w-2.5 h-2.5 rounded-full mr-2" style="background-color: rgb(107, 114, 128);"></div>
                            <span class="text-xs font-medium" style="color: rgb(75, 85, 99);">Cancelled</span>
                          </div>
                          <span class="text-sm font-bold text-right" style="color: rgb(75, 85, 99);">{{ cancelled_analyses or 0 }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
	              </div>
							</div>

							<!-- Analysis Results Table -->
							<div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg mb-6">
	              <div class="relative">
                  <div class="flex ioajsklehsnm mb-6">
                    <h4 class="text-base font-bold">Analysis Results</h4>
                    <span class="text-gray-500 text-sm">Last 5 successful runs</span>
                  </div>

                  <!-- Table Content -->
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                          <th scope="col" class="px-3 py-2 text-left">Analysis Name</th>
                          <th scope="col" class="px-3 py-2 text-left">Individual</th>
                          <th scope="col" class="px-3 py-2 text-left">Completed</th>
                          <th scope="col" class="px-3 py-2 text-left">Results</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% if recent_analyses %}
                          {% for analysis in recent_analyses %}
                          <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <td class="px-3 py-2 font-medium text-gray-900 dark:text-white">{{ analysis.name }}</td>
                            <td class="px-3 py-2 text-gray-700 dark:text-gray-300">
                              {% if analysis.individual %}
                                {{ analysis.individual.identity or 'N/A' }}
                              {% else %}
                                Individual {{ analysis.individual_id or 'N/A' }}
                              {% endif %}
                            </td>
                            <td class="px-3 py-2 text-gray-700 dark:text-gray-300">
                              {% if analysis.completed_at %}
                                {{ analysis.completed_at.strftime('%Y-%m-%d %H:%M') }}
                              {% else %}
                                N/A
                              {% endif %}
                            </td>
                            <td class="px-3 py-2">
                              {% if analysis.output_html %}
                                <a href="{{ url_for('routes.serve_analysis_report', analysis_id=analysis.id) }}" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline">
                                  View Report
                                </a>
                              {% else %}
                                <span class="text-gray-500 dark:text-gray-400">No Report</span>
                              {% endif %}
                            </td>
                          </tr>
                          {% endfor %}
                        {% else %}
                          <tr class="bg-white dark:bg-gray-800">
                            <td colspan="4" class="px-3 py-4 text-center text-gray-500 dark:text-gray-400">
                              No completed analyses found
                            </td>
                          </tr>
                        {% endif %}
                      </tbody>
                    </table>
                  </div>
	              </div>
							</div>
						</div>
						<div class="shrink max-w-full uajskeiolksb w-full lg:w-1/2 mb-6">
          		<!-- System Monitoring -->
          		<div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg h-full">
          			<div class="flex klsuaonrmcha vlaoethsnkma pb-6">
								  <div class="flex ioajsklehsnm">
		                <h3 class="text-base font-bold">System Monitoring</h3>
		                <span class="text-gray-500 text-sm">Real-time Resource Usage</span>
		              </div>
		            </div>
	              <!-- Gauge Charts Grid -->
	              <div class="grid grid-cols-2 gap-x-4 gap-y-4">
	                <!-- CPU Usage Gauge -->
	                <div class="flex justify-center items-center">
	                  <div class="relative w-30 h-30">
	                    <canvas id="CPUGaugeChart" class="max-w-full max-h-full"></canvas>
	                  </div>
	                </div>

	                <!-- Memory Usage Gauge -->
	                <div class="flex justify-center items-center">
	                  <div class="relative w-30 h-30">
	                    <canvas id="MemoryGaugeChart" class="max-w-full max-h-full"></canvas>
	                  </div>
	                </div>

	                <!-- Blank spacers for each column -->
	                <div class="h-8"></div>
	                <div class="h-8"></div>

	                <!-- Storage Usage Gauge -->
	                <div class="flex justify-center items-center">
	                  <div class="relative w-30 h-30">
	                    <canvas id="StorageGaugeChart" class="max-w-full max-h-full"></canvas>
	                  </div>
	                </div>

	                <!-- Docker Resources Gauge -->
	                <div class="flex justify-center items-center">
	                  <div class="relative w-30 h-30">
	                    <canvas id="DockerGaugeChart" class="max-w-full max-h-full"></canvas>
	                  </div>
	                </div>
	              </div>
							</div>
						</div>
					</div>



					<!-- row -->
					<div class="flex flex-wrap klsuaonrmcha">
          	<div class="shrink max-w-full uajskeiolksb w-full mb-6">
          		<div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg h-full">
          			<div class="flex klsuaonrmcha vlaoethsnkma pb-6">
								  <div class="flex ioajsklehsnm">
		                <h3 class="text-base font-bold">Phenotype Distribution</h3>
		                <span class="text-gray-500 text-sm">HPO terms from current individuals (top 10)</span>
		              </div>
		            </div>
          			<div class="relative aspect-[4/2]">
			            <canvas class="max-w-full" id="PhenotypeHistogram"></canvas>
	              </div>
							</div>
						</div>
					</div>
				</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gauge Charts for System Monitoring

    // CPU Usage Gauge
    const cpuCtx = document.getElementById('CPUGaugeChart');
    if (cpuCtx) {
        const cpuUsage = {{ system_metrics.cpu_usage }};
        const cpuAvailable = 100 - cpuUsage;
        const cpuCores = {{ system_metrics.cpu_cores }};
        const cpuCoresUsed = {{ system_metrics.cpu_cores_used }};

        new Chart(cpuCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [cpuUsage, cpuAvailable],
                    backgroundColor: ['rgb(59, 130, 246)', 'rgb(229, 231, 235)'],
                    borderWidth: 0,
                    cutout: '70%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            },
            plugins: [{
                id: 'gaugeText',
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    const centerX = chart.width / 2;
                    const centerY = chart.height / 2;

                    ctx.fillStyle = 'rgb(59, 130, 246)';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(cpuUsage + '%', centerX, centerY - 10);

                    ctx.fillStyle = 'rgb(107, 114, 128)';
                    ctx.font = '12px Arial';
                    ctx.fillText('CPU Usage', centerX, centerY + 15);
                    ctx.fillText(cpuCoresUsed + '/' + cpuCores + ' cores', centerX, centerY + 30);
                }
            }]
        });
    }

    // Memory Usage Gauge
    const memoryCtx = document.getElementById('MemoryGaugeChart');
    if (memoryCtx) {
        const memoryUsage = {{ system_metrics.memory_usage }};
        const memoryAvailable = 100 - memoryUsage;
        const memoryUsed = {{ system_metrics.memory_used }};
        const memoryTotal = {{ system_metrics.memory_total }};

        new Chart(memoryCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [memoryUsage, memoryAvailable],
                    backgroundColor: ['rgb(249, 115, 22)', 'rgb(229, 231, 235)'],
                    borderWidth: 0,
                    cutout: '70%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            },
            plugins: [{
                id: 'gaugeText',
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    const centerX = chart.width / 2;
                    const centerY = chart.height / 2;

                    ctx.fillStyle = 'rgb(249, 115, 22)';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(memoryUsage + '%', centerX, centerY - 10);

                    ctx.fillStyle = 'rgb(107, 114, 128)';
                    ctx.font = '12px Arial';
                    ctx.fillText('Memory', centerX, centerY + 15);
                    ctx.fillText(memoryUsed + '/' + memoryTotal + ' GB', centerX, centerY + 30);
                }
            }]
        });
    }

    // Storage Usage Gauge
    const storageCtx = document.getElementById('StorageGaugeChart');
    if (storageCtx) {
        const storageUsage = {{ system_metrics.storage_usage }};
        const storageAvailable = 100 - storageUsage;
        const storageUsed = {{ system_metrics.storage_used }};
        const storageTotal = {{ system_metrics.storage_total }};

        new Chart(storageCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [storageUsage, storageAvailable],
                    backgroundColor: ['rgb(34, 197, 94)', 'rgb(229, 231, 235)'],
                    borderWidth: 0,
                    cutout: '70%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            },
            plugins: [{
                id: 'gaugeText',
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    const centerX = chart.width / 2;
                    const centerY = chart.height / 2;

                    ctx.fillStyle = 'rgb(34, 197, 94)';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(storageUsage + '%', centerX, centerY - 10);

                    ctx.fillStyle = 'rgb(107, 114, 128)';
                    ctx.font = '12px Arial';
                    ctx.fillText('Storage', centerX, centerY + 15);
                    ctx.fillText(storageUsed + '/' + storageTotal + ' GB', centerX, centerY + 30);
                }
            }]
        });
    }

    // Docker Resources Gauge
    const dockerCtx = document.getElementById('DockerGaugeChart');
    if (dockerCtx) {
        const dockerRunning = {{ system_metrics.docker_running }};
        const dockerTotal = {{ system_metrics.docker_containers }};
        const dockerStopped = dockerTotal - dockerRunning;

        new Chart(dockerCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [dockerRunning, dockerStopped],
                    backgroundColor: ['rgb(168, 85, 247)', 'rgb(229, 231, 235)'],
                    borderWidth: 0,
                    cutout: '70%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            },
            plugins: [{
                id: 'gaugeText',
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    const centerX = chart.width / 2;
                    const centerY = chart.height / 2;

                    ctx.fillStyle = 'rgb(168, 85, 247)';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(dockerRunning, centerX, centerY - 10);

                    ctx.fillStyle = 'rgb(107, 114, 128)';
                    ctx.font = '12px Arial';
                    ctx.fillText('Containers', centerX, centerY + 15);
                    ctx.fillText(dockerRunning + '/' + dockerTotal + ' Running', centerX, centerY + 30);
                }
            }]
        });
    }

    // Analysis Status Pie Chart
    const analysisCtx = document.getElementById('AnalysisStatusChart');
    if (analysisCtx) {
        // Get data from template variables
        const pendingCount = {{ pending_analyses or 0 }};
        const runningCount = {{ running_analyses or 0 }};
        const completedCount = {{ successful_analyses or 0 }};
        const failedCount = {{ failed_analyses or 0 }};
        const cancelledCount = {{ cancelled_analyses or 0 }};

        // Filter out zero values for cleaner chart
        const statusData = [
            {label: 'Pending', count: pendingCount, color: 'rgb(234, 179, 8)'},
            {label: 'Running', count: runningCount, color: 'rgb(59, 130, 246)'},
            {label: 'Completed', count: completedCount, color: 'rgb(34, 197, 94)'},
            {label: 'Failed', count: failedCount, color: 'rgb(239, 68, 68)'},
            {label: 'Cancelled', count: cancelledCount, color: 'rgb(107, 114, 128)'}
        ].filter(item => item.count > 0);

        new Chart(analysisCtx, {
            type: 'pie',
            data: {
                labels: statusData.map(item => item.label),
                datasets: [{
                    data: statusData.map(item => item.count),
                    backgroundColor: statusData.map(item => item.color),
                    borderWidth: 2,
                    borderColor: '#fff',
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false  // Hide the default legend
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.parsed / total) * 100);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: 'white',
                        font: {
                            weight: 'bold',
                            size: 14
                        },
                        formatter: function(value, context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return value + '\n(' + percentage + '%)';
                        },
                        textAlign: 'center'
                    }
                },
                layout: {
                    padding: 5
                }
            },
            plugins: [{
                id: 'datalabels',
                afterDatasetsDraw: function(chart) {
                    const ctx = chart.ctx;
                    const labels = chart.data.labels;

                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        if (!meta.hidden) {
                            meta.data.forEach((element, index) => {
                                // Get the position
                                const model = element;
                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((dataset.data[index] / total) * 100);

                                // Set font style
                                ctx.fillStyle = 'white';
                                ctx.font = 'bold 12px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';

                                // Calculate position
                                const position = element.tooltipPosition();

                                // Draw the text (3 lines)
                                const text1 = labels[index]; // Status name (Pending, Running, Completed)
                                const text2 = dataset.data[index].toString(); // Value
                                const text3 = '(' + percentage + '%)'; // Percentage

                                ctx.fillText(text1, position.x, position.y - 12);
                                ctx.fillText(text2, position.x, position.y);
                                ctx.fillText(text3, position.x, position.y + 12);
                            });
                        }
                    });
                }
            }]
        });
    }

    // Doughnut Chart (if exists)
    const doughnutCtx = document.getElementById('DoughnutChart');
    if (doughnutCtx) {
        new Chart(doughnutCtx, {
            type: 'doughnut',
            data: {
                labels: ['VCF Processing', 'HPO Analysis', 'Exomiser Execution', 'Report Generation'],
                datasets: [{
                    data: [35, 25, 30, 10],
                    backgroundColor: [
                        'rgb(59, 130, 246)',
                        'rgb(34, 197, 94)',
                        'rgb(249, 115, 22)',
                        'rgb(168, 85, 247)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Phenotype Histogram
    const phenotypeCtx = document.getElementById('PhenotypeHistogram');
    if (phenotypeCtx) {
        // Get data from template variables
        const phenotypeLabels = {{ phenotype_labels | tojson }};
        const phenotypeCounts = {{ phenotype_counts | tojson }};

        // Generate colors dynamically based on the number of phenotypes
        const colors = [
            'rgba(59, 130, 246, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(249, 115, 22, 0.8)',
            'rgba(168, 85, 247, 0.8)',
            'rgba(236, 72, 153, 0.8)',
            'rgba(34, 197, 94, 0.8)',
            'rgba(239, 68, 68, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(99, 102, 241, 0.8)',
            'rgba(20, 184, 166, 0.8)'
        ];

        const borderColors = [
            'rgb(59, 130, 246)',
            'rgb(16, 185, 129)',
            'rgb(249, 115, 22)',
            'rgb(168, 85, 247)',
            'rgb(236, 72, 153)',
            'rgb(34, 197, 94)',
            'rgb(239, 68, 68)',
            'rgb(245, 158, 11)',
            'rgb(99, 102, 241)',
            'rgb(20, 184, 166)'
        ];

        new Chart(phenotypeCtx, {
            type: 'bar',
            data: {
                labels: phenotypeLabels,
                datasets: [{
                    label: 'Frequency',
                    data: phenotypeCounts,
                    backgroundColor: colors.slice(0, phenotypeLabels.length),
                    borderColor: borderColors.slice(0, phenotypeLabels.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 5
                        },
                        title: {
                            display: true,
                            text: 'Number of Cases'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Phenotypes (HPO Terms)'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Cases: ' + context.parsed.y;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}
