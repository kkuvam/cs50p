{% extends 'layout.html' %}

{% block title %}Add Patient | Exomiser App{% endblock %}

{% block description %}Add New Patient Record{% endblock %}

{% block content %}
<div class="mx-auto p-6 max-w-4xl">
  <!-- Header -->
  <div class="mb-8">
    <nav class="flex mb-4" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="{{ url_for('patient.patient_list') }}" class="text-gray-700 hover:text-indigo-600 dark:text-gray-300 dark:hover:text-indigo-400">Patients</a>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-gray-500 dark:text-gray-400 ml-1 md:ml-2">Add Patient</span>
          </div>
        </li>
      </ol>
    </nav>
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Add New Patient</h1>
    <p class="text-gray-600 dark:text-gray-400">Create a new patient record for genomic analysis</p>
  </div>

  <!-- Patient Add Form -->
  <form method="POST" enctype="multipart/form-data" class="space-y-8">
    <!-- Basic Information Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
      <div class="flex items-center mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Basic Information</h2>
        <span class="ml-2 px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Required</span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="individual_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Individual ID <span class="text-red-500">*</span>
          </label>
          <input type="text" id="individual_id" name="individual_id" required
                 placeholder="e.g., P0001"
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
        </div>

        <div>
          <label for="full_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Full Name <span class="text-red-500">*</span>
          </label>
          <input type="text" id="full_name" name="full_name" required
                 placeholder="Patient's full name"
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
        </div>

        <div>
          <label for="sex" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Sex <span class="text-red-500">*</span>
          </label>
          <select id="sex" name="sex" required
                  class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
            <option value="">Select sex</option>
            <option value="MALE">Male</option>
            <option value="FEMALE">Female</option>
            <option value="OTHER">Other</option>
            <option value="UNKNOWN">Unknown</option>
          </select>
        </div>

        <div>
          <label for="age_years" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Age (years) <span class="text-red-500">*</span>
          </label>
          <input type="number" id="age_years" name="age_years" required min="0" max="150"
                 placeholder="Age in years"
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
        </div>
      </div>
    </div>

    <!-- Medical Information Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
      <div class="flex items-center mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Medical Information</h2>
        <span class="ml-2 px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">Optional</span>
      </div>

      <div class="grid grid-cols-1 gap-6">
        <div>
          <label for="diagnosis" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Primary Diagnosis
          </label>
          <input type="text" id="diagnosis" name="diagnosis"
                 placeholder="Primary clinical diagnosis"
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
        </div>

        <div>
          <label for="medical_history" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Medical History
          </label>
          <textarea id="medical_history" name="medical_history" rows="4"
                    placeholder="Relevant medical history, symptoms, or clinical notes"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white"></textarea>
        </div>
      </div>
    </div>

    <!-- HPO Phenotype Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
      <div class="flex items-center mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Phenotype (HPO Terms)</h2>
        <span class="ml-2 px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Required</span>
      </div>

      <div class="space-y-4">
        <div>
          <label for="hpo-search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Search HPO Terms <span class="text-red-500">*</span>
          </label>
          <select id="hpo-search" class="w-full"></select>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Search and select Human Phenotype Ontology terms that describe the patient's phenotype</p>
        </div>

        <div>
          <label for="chosen-list" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Selected HPO Terms
          </label>
          <select id="chosen-list" name="hpo_ids[]" multiple
                  class="w-full h-48 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white">
          </select>
          <input type="hidden" name="hpo_terms" id="hpo_terms">
        </div>

        <button type="button" id="remove-btn"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
          Remove Selected
        </button>
      </div>
    </div>

    <!-- VCF File Upload Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
      <div class="flex items-center mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">VCF File Upload</h2>
        <span class="ml-2 px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Required</span>
      </div>

      <div>
        <label for="vcf_file" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          VCF File <span class="text-red-500">*</span>
        </label>
        <input type="file" id="vcf_file" name="vcf_file" accept=".vcf,.vcf.gz" required
               class="block w-full text-sm text-gray-500 dark:text-gray-400
                      file:mr-4 file:py-3 file:px-6
                      file:rounded-lg file:border-0
                      file:text-sm file:font-semibold
                      file:bg-indigo-50 file:text-indigo-700
                      hover:file:bg-indigo-100
                      dark:file:bg-indigo-900 dark:file:text-indigo-300
                      border border-gray-300 dark:border-gray-600 rounded-lg
                      focus:ring-2 focus:ring-indigo-500 focus:border-transparent
                      dark:bg-gray-700">
        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
          Upload a VCF (.vcf) or compressed VCF (.vcf.gz) file containing genomic variants
        </p>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="flex justify-end space-x-4 pt-6">
      <a href="{{ url_for('patient.patient_list') }}"
         class="px-6 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
        Cancel
      </a>
      <button type="submit"
              class="px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
        Create Patient
      </button>
    </div>
  </form>
</div>

<!-- Select2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"/>

<!-- jQuery and Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Mock HPO terms data (in real app, this would come from an API)
    const hpoTerms = [
        { id: "HP:0001250", label: "Seizure" },
        { id: "HP:0001263", label: "Global developmental delay" },
        { id: "HP:0000252", label: "Microcephaly" },
        { id: "HP:0000256", label: "Macrocephaly" },
        { id: "HP:0001249", label: "Intellectual disability" },
        { id: "HP:0000365", label: "Hearing impairment" },
        { id: "HP:0000508", label: "Ptosis" },
        { id: "HP:0001363", label: "Craniosynostosis" },
        { id: "HP:0002119", label: "Ventriculomegaly" },
        { id: "HP:0000347", label: "Micrognathia" },
        { id: "HP:0000316", label: "Hypertelorism" },
        { id: "HP:0000407", label: "Sensorineural hearing impairment" },
        { id: "HP:0001518", label: "Small for gestational age" },
        { id: "HP:0004322", label: "Short stature" },
        { id: "HP:0000639", label: "Nystagmus" },
        { id: "HP:0001251", label: "Ataxia" },
        { id: "HP:0001252", label: "Muscular hypotonia" },
        { id: "HP:0002910", label: "Elevated hepatic transaminase" },
        { id: "HP:0000286", label: "Epicanthus" },
        { id: "HP:0000348", label: "High forehead" }
    ];

    // Initialize Select2 for HPO search
    $('#hpo-search').select2({
        placeholder: 'Search for HPO terms...',
        allowClear: true,
        data: hpoTerms.map(term => ({
            id: term.id + '|' + term.label,
            text: term.id + ' - ' + term.label
        })),
        width: '100%'
    });

    // Store selected HPO terms
    let selectedHpoTerms = [];

    // Handle HPO term selection
    $('#hpo-search').on('select2:select', function (e) {
        const [id, label] = e.params.data.id.split('|');

        // Check if already selected
        if (!selectedHpoTerms.find(term => term.id === id)) {
            selectedHpoTerms.push({ id: id, label: label });
            updateChosenList();
            updateHiddenField();
        }

        // Clear the search
        $(this).val(null).trigger('change');
    });

    // Handle removal of selected terms
    $('#remove-btn').on('click', function() {
        $('#chosen-list option:selected').each(function() {
            const termId = $(this).val();
            selectedHpoTerms = selectedHpoTerms.filter(term => term.id !== termId);
        });
        updateChosenList();
        updateHiddenField();
    });

    // Update the chosen list display
    function updateChosenList() {
        const $chosenList = $('#chosen-list');
        $chosenList.empty();

        selectedHpoTerms.forEach(term => {
            $chosenList.append(
                $('<option>', {
                    value: term.id,
                    text: term.id + ' - ' + term.label
                })
            );
        });
    }

    // Update hidden field with JSON data
    function updateHiddenField() {
        $('#hpo_terms').val(JSON.stringify(selectedHpoTerms));
    }

    // Form validation
    $('form').on('submit', function(e) {
        if (selectedHpoTerms.length === 0) {
            e.preventDefault();
            alert('Please select at least one HPO term.');
            return false;
        }
    });
});
</script>

<style>
/* Custom Select2 styling */
.select2-container--default .select2-selection--single {
    height: 48px;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 24px;
    padding-left: 0;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 46px;
    right: 16px;
}

.select2-dropdown {
    border-radius: 0.5rem;
}

/* Dark mode support */
.dark .select2-container--default .select2-selection--single {
    background-color: #374151;
    border-color: #4b5563;
    color: #fff;
}

.dark .select2-dropdown {
    background-color: #374151;
    border-color: #4b5563;
}

.dark .select2-search__field {
    background-color: #374151;
    border-color: #4b5563;
    color: #fff;
}

.dark .select2-results__option {
    color: #fff;
}

.dark .select2-results__option[aria-selected=true] {
    background-color: #4f46e5;
}
</style>
{% endblock %}
